---
layout:     post                                  # 使用的布局（不需要改）
title:      《Linux 内核设计的艺术》学习笔记        # 标题 
subtitle:   当年学操作系统欠下的都是要还的……        # 副标题
date:       2022-11-16                     # 时间
author:     WYX                         # 作者
header-img: img/post-bg-badlands-national-park.jpg         # 这篇文章的标题背景图片
catalog: true                             # 是否归档
tags:                                    # 标签
    - 操作系统
    - 毕业设计
---

# 《Linux 内核设计的艺术》学习笔记

> 2022/11/16：感觉这种大砖头书一刷不太够，经常看不懂，回头再二刷……

## 第一章：从开机到执行 main.c

- 开机上电硬件启动 BIOS（此时为 16 位实模式

- BIOS 执行：
  
  - 加载中断向量表和中断服务程序
  
  - 调中断 int 0x19 加载第一扇区 bootsect.s（引导程序）
  
  - 加载四个扇区和扇区内容到内存

- bootsect.s 执行：
  
  - 调中断 int 0x13 加载 setup.s 程序到内存
  
  - 调中断 int 0x13 加载 system.s 程序到内存

- setup.s 执行：
  
  - 读机器系统数据
  
  - 关中断，将 system 移动到内存起始（覆盖 BIOS 中断 ）
  
  - 设置中断描述符表和全局描述符表，将专用寄存器指向表
  
  - 打开 A20 实现 32 位寻址
  
  - 重编程两块 8259 芯片将 CPU 工作模式设为保护模式

- head.s 执行：
  
  - 将寄存器转换为保护模式，设置页表，跳入 main.c 程序

## 第二章：从 main.c 到怠速

- main.c 执行：
  
  - 设置进程管理数据结构，如进程槽 task[]，进程的 task_struct 等
  
  - 复制根设备号、硬盘参数表
  
  - 根据物理内存大小规划使用
  
  - 设置外设虚拟盘
  
  - 初始化内存管理结构
  
  - 挂接异常处理中断
  
  - 准备使进程 0 能在 32 位保护模式下工作
    
    - 初始化块设备请求项管理 request[] 
    
    - 挂接串行口、键盘、显示器中断
    
    - 设置开机启动时间
  
  - 创建进程 0
  
  - 进程 0 执行：
    
    - 挂接进程 0 的数据结构和全局描述符表
    
    - 设置时钟中断
    
    - 挂接 system_call 和中断描述符表
    
    - 从内核态转换到用户态，调用 fork() 函数创建进程 1 
    
    - 在进程槽 task[] 为进程 1 申请空间
    
    - 复制进程信息、管理结构 task_struct 到进程 1
    
    - 设置进程 1 的线性地址空间、物理页面
    
    - 调用系统中断 pause() 切换到进程 1
  
  - 进程 1 执行：
    
    - 设置硬盘管理相关数据结构
    
    - 用虚拟盘代替软盘作为根设备
    
    - 用虚拟盘中的数据加载根文件系统
    
    - 从虚拟盘读取根文件系统的超级块，加载到超级块管理结构
    
    - 虚拟盘中读 i 节点，加载到 i 节点管理结构
  
  - 进程 1 执行：
    
    - 挂接进程 1 task_struct 的 filp[0] 和文件管理结构 file_table[0]
    
    - 解析 `/dev/tty` 文件路径
    
    - 找到 dev 目录的 tty0，载入 i 节点表中
    
    - 复制文件句柄建立关系，设定标准终端输出设备为 tty0
    
    - 进程 1 调用 fork() 函数创建进程 2
    
    - 发生时钟中断，中断返回，切换到进程 2
  
  - 进程 2 执行：
    
    - 为 shell 程序的执行做配置、环境准备（检测 shell 程序所在文件、调整进程 2 管理信息、地址值，调整 shell 程序第一条指令）
    
    - 执行 shell 第一条指令，引发缺页中断
    
    - 将 shell 程序载入新页
  
  - shell 进程执行：
    
    - 创建新进程 update
    
    - 执行 `/etc/rc` 文件
    
    - 调用 exit() 退出，切换去执行 update 进程
      
      > update 进程的主要任务是同步缓冲区和外设，因为 Linux 默认先写缓冲区再定期写回
  
  - 重建 shell 进程
    
    - 两次创建的区别：第一次 file[0] 挂载普通文件 `/etc/rc`，第二次挂载 tty0
    
    - 自此操作系统支持用户和计算机交互

## 第三章：安装文件系统

- 用户在 shell 输入 `mount /dev/hd1 /mnt` 开始安装文件系统

- 系统调用 sys_mount() （代码见 /fs/super.c）执行：
  
  - 获取硬盘设备号、获取虚拟盘挂接点
  
  - 获取设备文件超级块，载入到超级块管理结构 super_block[8]
  
  - 挂接硬盘设备文件超级块和 mnt 目录文件指定的 i 节点

## 第四章：文件操作
